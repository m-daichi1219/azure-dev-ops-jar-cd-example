# CI/CD パイプライン設計書

## 1. パイプライン概要

本ドキュメントは、Azure DevOps 環境における CI/CD パイプラインの設計方針と各フェーズの詳細を記述したものです。本パイプラインは、特定のリリースブランチ（例: `release/0.0.0`）が手動でトリガーされた際に稼働し、以降のバージョン番号（例: `release/1.2.3` など）を反映したリリースプロセスを実現するために設計されています。これにより、安定した自動ビルド、テスト、成果物生成、そして AWS EC2 へのデプロイが確実に行われるようにします。

## 2. パイプライン全体フロー

以下はパイプラインの主要な工程と各フェーズの連携概要です:

- **リリースブランチの指定:**

  - ブランチ名は `release/{version}` 形式となり、 `{version}` の部分にリリースバージョンが記載されます（例: `release/0.0.0`, `release/1.0.0`, `release/1.2.3` 等）。
  - このブランチに対して、手動トリガーによりパイプラインを実行します。

- **手動トリガー:**

  - パイプラインの開始は、Azure DevOps 上で手動実行とし、特定の `release/*` ブランチが対象となるよう設定します。

- **自動ビルド:**

  - Maven または Gradle を利用して Java アプリケーションのコンパイル及びユニットテストを実施し、成果物として jar/war ファイルを生成します。

- **テストフェーズ:**

  - 単体テストの実行により、リリース対象のコード品質と機能動作を検証し、結果はレポートとして出力されます。

- **成果物の生成と管理:**

  - 成功したビルド成果物に対して、リリースブランチ名からバージョン番号を抽出し、AWS S3 にアップロード・バージョン管理を実施します。

- **自動デプロイ:**
  - S3 へアップロードされた成果物は、AWS CLI/API や専用ツールを通じ、対象となる AWS EC2 インスタンスへデプロイされます。ローリングアップデートまたはブルーグリーンデプロイ戦略に基づいた安全な移行を実現します。

## 3. 各フェーズの詳細設計

### 3.1. ソースコード管理

- **ブランチ戦略:**

  - `release/{version}` ブランチをリリース対象とし、通常の開発ブランチやフィーチャーブランチから適切にマージされた状態で管理。
  - コードレビューやマージポリシーに基づく承認フローを確実に実施します。

- **トリガー設定:**
  - 手動トリガー専用のパイプラインとして設定し、対象ブランチが `release/*` の場合のみ実行されるようにフィルタリングします。

### 3.2. 自動ビルドフェーズ

- **使用ツール:**

  - Maven または Gradle を利用し、依存関係の解決、コンパイル、ユニットテストの実施、パッケージングを行います。

- **実行手順:**
  1. **リポジトリのチェックアウト:** 手動トリガーで対象ブランチからコードを取得
  2. **依存関係の管理:** 必要ライブラリのダウンロードとキャッシュ管理の設定
  3. **コンパイルとユニットテスト:** コンパイル実行後、テスト結果の収集
  4. **成果物生成:** 成功した場合に jar/war ファイルを生成

### 3.3. テストフェーズ

- **テスト実施内容:**

  - **単体テスト:** クラスおよびメソッド単位での動作確認

- **レポート管理:**
  - 各種テスト結果レポートおよびログファイルを Azure DevOps のアーティファクトとして格納・参照可能に設定

### 3.4. アーティファクト生成と AWS S3 へのアップロード

- **バージョン管理:**

  - 成果物には、`release/{version}` ブランチに基づくバージョン番号をタグとして付与
  - Git コミットハッシュなどの追加情報も含め、成果物の一意性を確保

- **アップロード手順:**
  1. 成果物の生成完了後、スクリプトまたは Azure DevOps のタスクを使用して AWS S3 バケットへアップロード
  2. S3 バージョニングを有効化し、過去の成果物管理およびリリース履歴のトラッキングを実施

### 3.5. 自動デプロイフェーズ

- **デプロイ戦略:**

  - **インプレースデプロイ (In-place Deployment):** シンプルさを優先し、既存の EC2 インスタンス上でアプリケーションを直接更新します。この方法ではデプロイ中に一時的なダウンタイムが発生します。

- **実行手順:**
  1. 対象となる AWS EC2 インスタンスに SSH 接続します。
  2. S3 から指定されたバージョンの最新成果物 (`.jar` ファイル等) をダウンロードします。
  3. 現在実行中のアプリケーションプロセスを停止します。
  4. ダウンロードした成果物を所定のディレクトリに配置（上書き）します。
  5. 必要に応じて設定ファイルを更新します。
  6. 新しいバージョンのアプリケーションプロセスを起動します。
  7. 簡単な動作確認（例: ヘルスチェックエンドポイントへのアクセス）を実施します。

## 4. エラー処理とロールバック戦略

- **エラー検知:**

  - ビルド、テスト、デプロイ各フェーズにおいてログ収集、エラーレポートの自動通知を実施
  - 手動介入が必要な場合は、Azure DevOps 通知や連携チャネル（例: Teams、Slack）にてアラートを発信

- **ロールバック:**
  - 直前の正常動作バージョンを基に、S3 上の既存アーティファクトからリストアを実施
  - ロールバック実行後、再度テスト・動作確認を徹底し、問題解決後の再リリースを促す

## 5. パイプラインの監視と報告

- **監視項目:**

  - 各ジョブの実行状況および成功率、エラー発生状況
  - デプロイ済み EC2 インスタンスのパフォーマンス、リソース使用率、ヘルスステータス

- **報告:**
  - 定期的なパイプライン実行レポートを自動生成し、関係者に配信
  - Azure DevOps のダッシュボードおよびログ解析ツールとの連携を通じて、リアルタイムの状態監視を実施
